---
import type { ArticleRow } from '../lib/types';
import { CATEGORY_META, type CategoryId } from '../lib/types';

interface Props {
  article: ArticleRow;
}
const { article } = Astro.props;

const cat = CATEGORY_META[article.category as CategoryId] || CATEGORY_META['other'];
const domain = (() => {
  try { return new URL(article.link).hostname.replace('www.', ''); }
  catch { return article.source_name; }
})();

const pubDate = article.pub_date ? new Date(article.pub_date) : null;
const timeAgo = (() => {
  if (!pubDate) return '';
  const diffMs = Date.now() - pubDate.getTime();
  const diffH = Math.floor(diffMs / 3_600_000);
  const diffD = Math.floor(diffMs / 86_400_000);
  if (diffH < 24) return `${diffH}h`;
  return `${diffD}d`;
})();

const catColorMap: Record<string, string> = {
  'ai-ml': 'bg-cat-ai/10 text-cat-ai',
  'security': 'bg-cat-security/10 text-cat-security',
  'engineering': 'bg-cat-engineering/10 text-cat-engineering',
  'tools': 'bg-cat-tools/10 text-cat-tools',
  'opinion': 'bg-cat-opinion/10 text-cat-opinion',
  'other': 'bg-cat-other/10 text-cat-other',
};
const catColor = catColorMap[article.category] || catColorMap['other'];
---
<article class="article-card bg-bg-card rounded-xl border border-gray-200/60 px-3 py-2.5 cursor-pointer">
  {/* Title */}
  <h3 class="text-[15px] font-medium leading-snug mb-1.5">
    <a class="text-text-primary visited:text-text-primary hover:text-accent-warm transition-colors break-words" href={article.link} target="_blank" rel="noopener" onclick="event.stopPropagation()">
      {article.title_zh || article.title}
    </a>
  </h3>

  {/* Metadata line */}
  <div class="flex flex-wrap items-center gap-x-1.5 gap-y-1 text-[11px] text-text-secondary leading-none">
    <span class={`inline-block px-1.5 py-px rounded-full font-medium ${catColor}`}>{cat.label}</span>
    {timeAgo && <span>{timeAgo}</span>}
    {domain && <><span class="opacity-30">·</span><span class="truncate max-w-[140px]">{domain}</span></>}
    <span class="opacity-30">·</span>
    <span>深度{article.depth} · 新颖{article.novelty} · 广度{article.breadth}</span>
    <svg class="chevron-icon w-3 h-3 ml-auto opacity-30" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
  </div>

  {/* Expandable details */}
  <div class="collapsed mt-2">
    <div class="inner">
      <div class="bg-bg-expanded rounded-lg p-2.5 space-y-2">
        {article.summary && (
          <p class="text-[13px] leading-relaxed text-text-primary">{article.summary}</p>
        )}
        {article.reason && (
          <blockquote class="border-l-2 border-accent-warm pl-2.5 text-[12px] text-text-secondary italic">
            {article.reason}
          </blockquote>
        )}
        {article.keywords && article.keywords.length > 0 && (
          <div class="flex flex-wrap gap-1">
            {article.keywords.map(kw => (
              <span class="inline-block px-1.5 py-px rounded-full bg-gray-100 text-[10px] text-text-secondary">{kw}</span>
            ))}
          </div>
        )}
        <div>
          <a class="text-accent-warm text-xs font-medium hover:underline inline-flex items-center gap-1 min-h-[32px]" href={article.link} target="_blank" rel="noopener" onclick="event.stopPropagation()">
            阅读原文
            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</article>
