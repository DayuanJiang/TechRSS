---
import Layout from '../../layouts/Layout.astro';
import { loadHnData } from '../../lib/data';
import type { HnStoredItem } from '../../lib/data';

export function getStaticPaths() {
  const hnData = loadHnData();
  const items = hnData?.items || [];
  return items.map(item => ({
    params: { id: String(item.id) },
    props: { item },
  }));
}

interface Props { item: HnStoredItem; }

const base = import.meta.env.BASE_URL.replace(/\/?$/, '/');
const { item } = Astro.props;
const ai = item.aiSummary || item.aisummary || {};
const pageTitle = ai.chinese_title || item.title;
---
<Layout title={`${pageTitle} - TechDigest`}>
  <!-- Back button -->
  <a href={`${base}hn/`} class="inline-flex items-center gap-1 text-accent-warm text-sm mb-3 hover:underline">
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    返回列表
  </a>

  <!-- Title section (static from list data) -->
  <div class="bg-bg-card rounded-xl border border-gray-200/60 px-3 py-3 mb-3">
    <h1 class="text-lg font-bold leading-snug mb-1 text-text-primary">{ai.emoji || ''} {pageTitle}</h1>
    {ai.chinese_title && <p class="text-[13px] text-text-secondary mb-2">{item.title}</p>}
    <div class="flex flex-wrap items-center gap-x-1.5 gap-y-1 text-[11px] text-text-secondary leading-none mb-3">
      <span class="font-medium text-accent-warm">{item.score} 分</span>
      <span class="opacity-30">·</span>
      <span>{item.by}</span>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      {item.url && (
        <a href={item.url} target="_blank" rel="noopener" class="text-accent-warm hover:underline inline-flex items-center gap-1">
          阅读原文 <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
        </a>
      )}
      <a href={`https://news.ycombinator.com/item?id=${item.id}`} target="_blank" rel="noopener" class="text-accent-warm hover:underline inline-flex items-center gap-1">
        HN 讨论 <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
      </a>
    </div>
  </div>

  <!-- Detail content (loaded client-side from /item API) -->
  <div id="detail" data-id={String(item.id)}>
    <div id="detail-loading" class="space-y-2">
      <div class="skeleton-card bg-bg-card rounded-xl border border-gray-200/60 px-3 py-3">
        <div class="skeleton-line w-1/4 h-4 mb-2"></div>
        <div class="skeleton-line w-full h-16"></div>
      </div>
      <div class="skeleton-card bg-bg-card rounded-xl border border-gray-200/60 px-3 py-3">
        <div class="skeleton-line w-1/4 h-4 mb-2"></div>
        <div class="skeleton-line w-full h-12 mb-2"></div>
        <div class="skeleton-line w-full h-12"></div>
      </div>
    </div>
    <div id="detail-error" class="hidden text-center py-4">
      <p class="text-text-tertiary text-sm">详细摘要加载失败</p>
    </div>
    <div id="detail-content" class="hidden"></div>
  </div>

  <script is:inline>
    (function () {
      var loading = document.getElementById('detail-loading');
      var error = document.getElementById('detail-error');
      var content = document.getElementById('detail-content');
      var id = document.getElementById('detail').dataset.id;

      function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      fetch('https://api.newshacker.me/item/' + id)
        .then(function (r) { return r.ok ? r.json() : null; })
        .then(function (data) {
          if (!data) throw new Error('no data');
          var ai = data.aiSummary || data.aisummary || {};
          var context = ai.context || '';
          var discussions = ai.discussion_overview || [];
          var terms = ai.terminologies || [];
          var html = '';

          if (context) {
            html += '<div class="bg-bg-card rounded-xl border border-gray-200/60 px-3 py-3 mb-3">';
            html += '<h2 class="text-sm font-semibold text-text-primary mb-2">讨论背景</h2>';
            html += '<p class="text-[13px] leading-relaxed text-text-secondary">' + escapeHtml(context) + '</p>';
            html += '</div>';
          }

          if (discussions.length > 0) {
            html += '<div class="mb-3">';
            html += '<h2 class="text-sm font-semibold text-text-primary mb-2">讨论焦点</h2>';
            html += '<div class="space-y-2">';
            for (var i = 0; i < discussions.length; i++) {
              var d = discussions[i];
              html += '<div class="discussion-card bg-bg-card rounded-xl border border-gray-200/60 px-3 py-2.5">';
              html += '<div class="text-xs font-medium text-accent-warm mb-1">' + escapeHtml(d.category) + '</div>';
              html += '<p class="text-[13px] leading-relaxed text-text-primary">' + escapeHtml(d.summary) + '</p>';
              if (d.supportid && d.supportid.length > 0) {
                html += '<div class="flex flex-wrap gap-1 mt-1.5">';
                for (var j = 0; j < d.supportid.length; j++) {
                  html += '<a href="https://news.ycombinator.com/item?id=' + d.supportid[j] + '" target="_blank" rel="noopener" class="text-[10px] text-accent-muted hover:text-accent-warm hover:underline">#' + d.supportid[j] + '</a>';
                }
                html += '</div>';
              }
              html += '</div>';
            }
            html += '</div></div>';
          }

          if (terms.length > 0) {
            html += '<div class="bg-bg-card rounded-xl border border-gray-200/60 px-3 py-3">';
            html += '<h2 class="text-sm font-semibold text-text-primary mb-2">术语解释</h2>';
            html += '<dl class="space-y-1.5">';
            for (var k = 0; k < terms.length; k++) {
              html += '<div>';
              html += '<dt class="text-[13px] font-medium text-text-primary">' + escapeHtml(terms[k].term) + '</dt>';
              html += '<dd class="text-[12px] text-text-secondary leading-relaxed">' + escapeHtml(terms[k].explanation) + '</dd>';
              html += '</div>';
            }
            html += '</dl></div>';
          }

          if (!html) {
            html = '<div class="text-center py-4"><p class="text-text-tertiary text-sm">暂无详细摘要</p></div>';
          }

          content.innerHTML = html;
          loading.classList.add('hidden');
          content.classList.remove('hidden');
        })
        .catch(function () {
          loading.classList.add('hidden');
          error.classList.remove('hidden');
        });
    })();
  </script>
</Layout>
